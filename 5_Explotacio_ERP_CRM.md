---
title: UD05: Explotaci√≥ de sistemes ERP-CRM
language: VAL
author: Toni Santos Silvestre [https://github.com/ToniSantosSilvestre]
subject: Sistemes de Gesti√≥ Empresarial
keywords: [SGE, 2024, Sistemes de Gesti√≥ Empresarial,Python]
IES: CIPFP Batoi (Alcoi) [https://portal.edu.gva.es/cipfpbatoi/]
header: ${title} - ${subject} (ver: ${today})
footer:${currentFileName}.pdf - ${author} - ${IES} - ${pageNo}/${pageCount}
typora-root-url:${filename}/../
typora-copy-images-to:${filename}/../assets
---

[TOC]

## 1. INTRODUCCI√ì
Odoo √©s un ERP-CRM de codi obert que es distribueix sota dos tipus de desplegament:

- On-premise en GNU/Linux o Windows amb dues versions (Community, gratu√Øta i Enterprise, de pagament).
- SaaS (Programari As A Service): l‚Äôempresa que desenvolupa Odoo tamb√© proporciona el seu servei en el n√∫vol. 

D'aquesta manera, una empresa pot tenir el seu propi Odoo en un servidor local, en un n√∫vol propi o en un n√∫vol de tercers. Tamb√© pot tenir acc√©s a Odoo pel SaaS d'Odoo o d'altres terceres empreses que proporcionen Odoo com SaaS.

La llic√®ncia d'Odoo ha anat canviant al llarg del temps. La llic√®ncia actual, de la versi√≥ 18 'Community' √©s LGPLv3.

Odoo t√© una arquitectura ‚Äúclient-servidor‚Äù de 3 capes:

- La base de dades en un servidor PostgreSQL.
- El servidor Odoo, que engloba la l√≤gica de negoci i el servidor web.
- La capa de client que √©s un SPA (Single Page Application). La capa client est√† dividida en almenys 3 interf√≠cies molt diferenciades:
    - El ‚ÄúBackend‚Äù on s'administra la base de dades per part dels administradors i empleats de l'empresa.
    - El ‚ÄúFrontend‚Äù o p√†gina web, on poden accedir els clients i empleats. Pot incloure una botiga i altres aplicacions.
    - El ‚ÄúTPV‚Äù per als terminals punt de venda que poden ser t√†ctils.

> üí¨ **Atenci√≥**: a m√©s d'usar el seu propi client, Odoo admet que altres aplicacions interactuen amb el seu servidor usant XML-RPC. Tamb√© es poden desenvolupar ‚Äúweb controllers‚Äù per a crear una API per a aplicacions web o m√≤bils, per exemple.

A part de l'arquitectura de 3 capes, Odoo √©s un sistema modular. Aix√≤ vol dir que es pot ampliar amb m√≤duls de tercers (oficials o no) i m√≤duls desenvolupats per nosaltres mateixos.

De fet, en Odoo hi ha un m√≤dul ‚Äúbase‚Äù que cont√© el funcionament b√†sic del servidor i a partir d'ac√≠ es carreguen tots els altres m√≤duls.

Quan instal¬∑lem Odoo, abans d'instal¬∑lar cap m√≤dul, tenim acc√©s al ‚Äúbackend‚Äù on gestionar poc m√©s que les opcions i usuaris. √âs necessari instal¬∑lar els m√≤duls necessaris per a un funcionament m√≠nim. Per exemple, el m√©s t√≠pic √©s instal¬∑lar almenys els m√≤duls de vendes, compres, CRM i comptabilitat.

Per a ampliar les funcionalitats o adaptar Odoo a les necessitats d'una empresa, no cal modificar el codi font d'Odoo. Tan sols necessitem crear un m√≤dul.

Els **m√≤duls d'Odoo** poden modificar el comportament del programa, l'estructura de la base de dades i/o la interf√≠cie d'usuari. En principi, un m√≤dul es pot instal¬∑lar i desinstal¬∑lar i els canvis que implicava el m√≤dul es reverteixen completament.
<imatge>
Odoo facilita el desenvolupament de m√≤duls perqu√®, a m√©s d'un ERP, √©s un framework de programaci√≥. Odoo t√© el seu propi framework tipus **RAD (Rapid Application Development)**. Aix√≤ significa que amb poc esfor√ß es poden aconseguir aplicacions amb altes prestacions i segures.

>‚ùï**Atenci√≥**: el poc esfor√ß √©s relatiu. Per a desenvolupar correctament en Odoo s√≥n necessaris amplis coneixements de Python, XML, HTML, Javascript i altres tecnologies associades com QWeb, JQuery, XML-RPC, etc. La corba d'aprenentatge √©s alta i la documentaci√≥ √©s escassa. A m√©s, els errors s√≥n m√©s dif√≠cils d'interpretar perqu√® no sabem tot el que est√† passant per davall. La frustraci√≥ inicial es veur√† compensada amb una major agilitat i menys errors.

Aquest framework es basa en alguns dels principis generals dels RAD moderns:

- La capa **ORM (Object Relational Mapping)** entre els objectes i la base de dades.
    - La combinaci√≥ **Classe Python ‚Üî ORM ‚Üî Tabla PostgreSQL** es coneix com a **Model**.
    - El programador no efectua el disseny de la base de dades, nom√©s de les classes i les seues relacions.
    - Tampoc √©s necessari fer consultes SQL, quasi tot es pot fer amb els m√®todes d'ORM d'Odoo.
- L‚Äôarquitectura **MVC** (Modelo-Vista-Controlador).
    - El model es programa declarant classes de Python que hereten de ‚Äú**models.Model**‚Äù. Aquesta her√®ncia provoca que actue l'ORM i √©s mapejen en la base de dades.
    - Les vistes es defineixen normalment en arxius XML i s√≥n llistes, formularis, calendaris, gr√†fics, men√∫s, etc. Aquest XML ser√† enviat al client web on el framework Javascript d'Odoo ho transforma en HTML.
    - El controlador tamb√© es defineix en fitxers Python, normalment al costat del model. El controlador s√≥n els m√®todes que proporcionen la l√≤gica de negoci.
- Odoo t√© una arquitectura de **Tinen√ßa M√∫ltiple**. De manera que un √∫nic servidor pot proporcionar servei a molts clients de bases de dades diferents.
- Odoo proporciona un dissenyador d'informes.
- El framework facilita la traducci√≥ de l'aplicaci√≥ a molts idiomes.

> üìñ **Important**: ja que Odoo facilita la traducci√≥, √©s una bona pr√†ctica programar tot en angl√©s, tant el nom de les variables com els textos que vam mostrar als usuaris. Posteriorment, podem afegir les traduccions necess√†ries.



## 2 La base de dades d'Odoo

Gr√†cies a l'ORM, no hi ha un disseny definit de la base de dades. La base de dades d'una empresa pot tenir algunes taules molt diferents d‚Äôaltres en funci√≥ del mapatge que l'ORM haja fet amb les classes actives en aquesta empresa. Per tant, √©s dif√≠cil trobar un disseny ‚Äúentitat-relaci√≥‚Äù o una cosa similar en la documentaci√≥ d'Odoo.

Cal afegir que Odoo t√© alguns models ja creats i ben documentats com:
- ‚Äúres.partner‚Äù (clients, prove√Ødors, etc.).
    - https://www.technaureus.com/odoo-partner-res-partner-concept/
- ‚Äúsale.order‚Äù (Ordre de venda).

Aquests models existeixen de base pel fet que estan en quasi totes les empreses i versions d'Odoo.

Per√≤ ni tan sols aquests tenen en la base de dades les mateixes columnes o relacions que en altres empreses. Moltes vegades necessitem saber el nom del model, del camp o de la taula en la base de dades. Per a aix√≤, Odoo proporciona en el seu ‚Äúbackend‚Äù el ‚Äúmode desenvolupador‚Äù per a saber el model i camp posant el ratol√≠ damunt d'un camp dels formularis.

> üìñ **Important**: el nom de les classes de Python sempre ha de ser en min√∫scula i amb el  punt per a separar per jerarquia. El nom d'un model, per tant, ser√†  sempre: ‚Äúmodul.model‚Äù. Si el model t√© un nom compost, se separa per ‚Äú_‚Äù.

> En la base de dades, el punt se substitueix per una barra baixa.



> üí¨ **Interessant**: aconsellem dedicar uns minuts a con√©ixer la base de dades usant el ‚Äúmode  desenvolupador‚Äù i el client de terminal de PostgreSQL. Per a aix√≤, podem repassar les consultes SQL traient, per exemple, el nom dels clients  que no han fet cap comanda.

## 3. Composici√≥ d'un m√≤dul

Odoo √©s un programa modular. Tant el servidor com el client es componen de m√≤duls que estenen al m√≤dul ‚Äúbase‚Äù. Qualsevol cosa que es vulga modificar en Odoo s'ha de fer creant un m√≤dul.

>üìñ **Important:** ja que Odoo √©s de codi obert i tot el codi est√† en Python, que no √©s un llenguatge compilat, podem alterar els fitxers Python o XML dels m√≤duls oficials, canviant el que ens interesse.

>**Aix√≤ pot funcionar, per√≤ √©s una mala pr√†ctica, ja que:**

>\- Qualsevol actualitzaci√≥ dels m√≤duls oficials esborraria els nostres canvis.

>\- Si no actualitzem, perdrem acc√©s a nova funcionalitats i estarem exposats a problemes de seguretat.

>\- Revertir canvis √©s m√©s dif√≠cil i la soluci√≥ sol passar per tornar a la versi√≥ oficial.

Podem crear m√≤duls per a modificar, eliminar o ampliar parts d'altres m√≤duls. Tamb√© podem crear m√≤duls per a afegir funcionalitats completament noves a Odoo sense interferir amb la resta del programa. En qualsevol cas, el sistema modular est√† dissenyat perqu√® es puguen instal¬∑lar i desinstal¬∑lar m√≤duls sense afectar la resta del programa.

**Exemple**: pot ser que una empresa no necessite totes les dades que demana Odoo en registrar un producte. Com a soluci√≥, podem fer un m√≤dul que elimine de la vista els camps innecessaris. Si despr√©s es comprova que aquells camps eren necessaris, nom√©s cal desinstal¬∑lar el m√≤dul i tornen a apar√©ixer.

Aquest sistema modular funciona perqu√®, cada vegada que es reinicia el servidor o s'actualitza un m√≤dul, s'interpreten els fitxers Python que defineixen els models i l'ORM mapeja les novetats en la base de dades. A m√©s, es carreguen les dades dels fitxers XML en la base de dades i s'actualitzen les dades que han canviat.

### 3.1 Composici√≥ d'un m√≤dul

Els m√≤duls modifiquen parts de Model-Vista-Controlador. D'aquesta manera, un m√≤dul es compon de fitxers Python, XML, CSS o Javascript entre altres. Tots aquests arxius han d'estar en una carpeta amb el nom del m√≤dul.



Hi ha una estructura de subcarpetes i de noms d'arxius que quasi tots els m√≤duls respecten. Per√≤ tot dep√©n del que pose en el fitxer ‚Äú**__manifest__.py‚Äù**. Aquest fitxer cont√© un diccionari de Python amb informaci√≥ del m√≤dul i la ubicaci√≥ dels altres fitxers. A m√©s, l'arxiu ‚Äú**__init__.py**‚Äù indica quins fitxers Python s'han d'importar.



Dins d'un m√≤dul podem trobar:

- Fitxers Python que defineixen els models i els controladors.
- Fitxers XML que defineixen dades que han d'anar a la base de dades. Dins d'aquestes dades, podem trobar:
    - Definici√≥ de les vistes i les accions.
    - Dades de demo.
    - Dades est√†tiques que necessita el m√≤dul.
- Fitxers est√†tics com a imatges, CSS, Javascript, etc. que han de ser carregats per la interf√≠cie web.
- Controladors web per a gestionar les peticions web.

Els m√≤duls es guarden en un directori indicat en l'opci√≥ ‚Äú**--addons-path**‚Äù en llan√ßar el servidor o en el fitxer de configuraci√≥ ‚Äú**odoo.conf**‚Äù. Els m√≤duls poden estar en m√©s d'un directori i depenen de la mena d'instal¬∑laci√≥ o la distribuci√≥ o versi√≥ que s'instal¬∑le.



Per a crear un m√≤dul es pot fer manualment creat la carpeta, el manifest, els directoris i fitxers o utilitzant una eina de l√≠nia de comandos anomenada ‚Äú**odoo scaffold**‚Äù.

> odoo scaffold nom_del_modul /ruta_don_colocarlo

Una vegada executat aquest comando, tenim en la ruta indicada, l'estructura b√†sica de directoris i fitxers amb una mica de codi d'exemple.

> ‚ùï**Atenci√≥:** encara que usar ‚Äúscaffold‚Äù ens proporciona una base, durant la unitat pot ser bona idea basar-se en exemples proporcionats a classe.

## 4.  Models

## 4.1 Introducci√≥ als models en Odoo

Els models s√≥n una abstracci√≥ pr√≤pia de molts frameworks i relacionada amb l'ORM. Un model es defineix com una classe Python que hereta de la classe ‚Äú**models.Model**‚Äù. En heretar d'aquesta classe, adquireix unes propietats de manera transparent per al programador. A partir d'aquest moment, les classes del llenguatge de programaci√≥ queden per davall d'un nivell m√©s d'abstracci√≥.

Una classe heretada de ‚Äúmodels.Model‚Äù es comporta de la seg√ºent manera:

- Pot ser accedida com a model, com ‚Äúrecordset‚Äù (conjunt de registres) o com ‚Äúsingleton‚Äù (un unic registre). Si √©s accedida com a model, t√© m√®todes de model per a crear ‚Äúrecordsets‚Äù, per exemple. Si √©s accedida com ‚Äúrecordset‚Äù, es pot accedir a les dades que guarda.
- Pot tenir atributs interns de la classe, ja que continua sent Python. Per√≤ els atributs que es guarden en la base de dades s'han de definir com ‚Äúfields‚Äù. Un ‚Äúfield‚Äù √©s una inst√†ncia de la classe ‚Äúfields.Field‚Äù, i t√© els seus propis atributs i funcions.
    - Odoo analitzar√† el model, cercar√† els atributs tipus ‚Äúfield‚Äù i les seues propietats i mapear√° autom√†ticament tot aix√≤ en l'ORM.
- Els m√®todes definits per als ‚Äúrecordset‚Äù reben un argument anomenat ‚Äúself‚Äù que pot ser un ‚Äúrecordset‚Äù amb una col¬∑lecci√≥ de registres. Per tant, han d'iterar en el self per a fer la seua funci√≥ en cadascun dels registres.
- Un model representa a la taula sencera en la base de dades. Un ‚Äúrecordset‚Äù representa a una col¬∑lecci√≥ de registres d'aqueixa taula i tamb√© al model. Un ‚Äúsingleton‚Äù √©s un ‚Äúrecordset‚Äù d'un sol element.
- Els models tenen les seues pr√≤pies funcions per a no haver d'accedir a la base de dades per a modificar o crear registres. A m√©s, incorporen restriccions d'integritat.

Aquest √©s l'exemple d'un model amb solament un ‚Äúfield‚Äù: